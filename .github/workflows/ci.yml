name: CI

on:
  push:
    paths:
      - 'lambdas/**'
      - 'infra/**'
      - '.github/actions/**'
      - '.github/workflows/ci.yml'
  pull_request:
    paths:
      - 'lambdas/**'
      - 'infra/**'
      - '.github/actions/**'
      - '.github/workflows/ci.yml'

jobs:
  build-lambdas:
    name: Build Lambda ${{ matrix.lambda_name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - lambda_name: photosHandler
            path: lambdas/api/photosHandler
          - lambda_name: rollsHandler
            path: lambdas/api/rollsHandler
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and package
        uses: ./.github/actions/build-lambda
        with:
          lambda_name: ${{ matrix.lambda_name }}
          path: ${{ matrix.path }}
          node_version: '22'

  terraform:
    name: Terraform fmt/validate/plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Terraform CI
        uses: ./.github/actions/terraform-ci
        with:
          working_directory: infra
          terraform_version: '1.9.5'
          configure_aws: 'true'
          aws_role_to_assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws_region: 'eu-west-1'
